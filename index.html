<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verified Electronics — SO / Invoice</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div class="w-full h-1.5 bg-gradient-to-r from-purple-600 via-fuchsia-600 to-indigo-600"></div>

  <div class="max-w-6xl mx-auto p-6 md:p-10 space-y-6">
    <!-- Header -->
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-16 h-16 rounded-2xl bg-white shadow-sm ring-1 ring-slate-100 flex items-center justify-center overflow-hidden">
          <img id="logoPreview" alt="Verified Electronics" class="max-w-14 max-h-14 hidden" />
          <span id="logoPlaceholder" class="text-[11px] text-slate-400">Logo</span>
        </div>
        <h1 class="text-2xl md:text-3xl font-semibold tracking-tight">Verified Electronics</h1>
      </div>
      <div class="flex items-center gap-2">
        <label class="inline-flex items-center gap-2 cursor-pointer">
          <input type="file" id="logoFile" accept="image/*" class="hidden" />
          <span class="px-3 py-2 rounded-xl bg-white shadow-sm ring-1 ring-slate-200 text-sm hover:bg-slate-50">Upload Logo</span>
        </label>
        <button id="generateBtn" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white font-semibold shadow-sm">
          Generate PDF
        </button>
      </div>
    </header>

    <!-- Options -->
    <section class="bg-white rounded-2xl p-4 md:p-5 shadow-sm ring-1 ring-slate-100">
      <div class="grid md:grid-cols-4 gap-4">
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-500 mb-1">Document Type</label>
          <select id="docType" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="so" selected>Sales Order Confirmation</option>
            <option value="invoice">Invoice</option>
          </select>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-500 mb-1">Currency</label>
          <select id="currency" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="USD" selected>USD</option>
            <option value="GBP">GBP</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-500 mb-1">Show GBP Equivalent?</label>
          <select id="showGbpEq" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <option value="no" selected>No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
        <div>
          <label class="block text-xs uppercase tracking-wide text-slate-500 mb-1">FX (1 GBP = ? {CUR})</label>
          <input id="fxRate" type="number" step="0.00001" class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="e.g., 1.32847">
        </div>
      </div>
    </section>

    <!-- Seller / Buyer / Order -->
    <section class="grid md:grid-cols-3 gap-4">
      <div class="bg-white rounded-2xl p-4 md:p-5 shadow-sm ring-1 ring-slate-100">
        <h2 class="font-semibold mb-3">Seller</h2>
        <label class="block text-sm mb-1">Seller Name</label>
        <input id="sellerName" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="Company name" />
        <label class="block text-sm mb-1">Address</label>
        <textarea id="sellerAddress" rows="4" class="w-full border rounded-lg px-3 py-2" placeholder="Address lines"></textarea>
        <div class="grid grid-cols-2 gap-3 mt-3">
          <div>
            <label class="block text-sm mb-1">VAT Number</label>
            <input id="sellerVat" class="w-full border rounded-lg px-3 py-2" placeholder="(optional)">
          </div>
          <div>
            <label class="block text-sm mb-1">Invoice/SO Date</label>
            <input id="docDate" type="date" class="w-full border rounded-lg px-3 py-2">
          </div>
        </div>
      </div>

      <div class="bg-white rounded-2xl p-4 md:p-5 shadow-sm ring-1 ring-slate-100">
        <h2 class="font-semibold mb-3">Buyer</h2>
        <label class="block text-sm mb-1">Company</label>
        <input id="buyerCompany" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="Customer Company Ltd." />
        <label class="block text-sm mb-1">Contact</label>
        <input id="buyerContact" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="Name / Email / Phone" />
        <label class="block text-sm mb-1">Bill To</label>
        <textarea id="billTo" rows="4" class="w-full border rounded-lg px-3 py-2" placeholder="Billing address"></textarea>
      </div>

      <div class="bg-white rounded-2xl p-4 md:p-5 shadow-sm ring-1 ring-slate-100">
        <h2 class="font-semibold mb-3">Order / Meta</h2>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">Number</label>
            <input id="docNumber" class="w-full border rounded-lg px-3 py-2" placeholder="SO- / INV-" />
          </div>
          <div>
            <label class="block text-sm mb-1">Customer PO #</label>
            <input id="poNumber" class="w-full border rounded-lg px-3 py-2" placeholder="(optional)" />
          </div>
          <div>
            <label class="block text-sm mb-1">Salesperson</label>
            <input id="salesperson" class="w-full border rounded-lg px-3 py-2" placeholder="Name" />
          </div>
          <div>
            <label class="block text-sm mb-1">Net Terms</label>
            <input id="netTerms" class="w-full border rounded-lg px-3 py-2" placeholder="e.g., Net 30" />
          </div>
        </div>
      </div>
    </section>

    <!-- Logistics -->
    <section class="grid md:grid-cols-3 gap-4">
      <div class="bg-white rounded-2xl p-4 md:p-5 shadow-sm ring-1 ring-slate-100">
        <h2 class="font-semibold mb-3">Ship To</h2>
        <textarea id="shipTo" rows="6" class="w-full border rounded-lg px-3 py-2" placeholder="Shipping address"></textarea>
      </div>
      <div class="bg-white rounded-2xl p-4 md:p-5 shadow-sm ring-1 ring-slate-100">
        <h2 class="font-semibold mb-3">Logistics</h2>
        <label class="block text-sm mb-1">Incoterms</label>
        <input id="incoterms" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="DAP / DDP / FCA / EXW" />
        <label class="block text-sm mb-1">Lead Time</label>
        <input id="leadTime" class="w-full border rounded-lg px-3 py-2 mb-3" placeholder="e.g., 10–12 days" />
        <label class="block text-sm mb-1">COO / HTS (note)</label>
        <input id="cooHts" class="w-full border rounded-lg px-3 py-2" placeholder="COO: __  HTS: __" />
      </div>
      <div class="bg-white rounded-2xl p-4 md:p-5 shadow-sm ring-1 ring-slate-100">
        <h2 class="font-semibold mb-3">VAT / Charges</h2>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm mb-1">VAT %</label>
            <input id="vatPct" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" placeholder="0">
          </div>
          <div>
            <label class="block text-sm mb-1">Shipping</label>
            <input id="shipping" type="number" step="0.01" class="w-full border rounded-lg px-3 py-2" placeholder="0.00">
          </div>
        </div>
        <label class="inline-flex items-center gap-2 mt-3 text-sm">
          <input type="checkbox" id="noVat" class="w-4 h-4">
          <span>No VAT (export/zero-rated)</span>
        </label>
      </div>
    </section>

    <!-- Line Items -->
    <section class="bg-white rounded-2xl p-4 md:p-5 shadow-sm ring-1 ring-slate-100">
      <div class="flex items-center justify-between mb-3">
        <h2 class="font-semibold">Line Items</h2>
        <button type="button" id="addRowBtn" class="px-3 py-2 text-sm rounded-xl text-white bg-gradient-to-r from-purple-600 via-fuchsia-600 to-indigo-600 hover:opacity-90">
          Add Item
        </button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm" id="itemsTable">
          <thead class="bg-slate-100">
            <tr>
              <th class="p-2 text-left">Part Number</th>
              <th class="p-2 text-left">Description</th>
              <th class="p-2 text-left">Qty</th>
              <th class="p-2 text-left">Unit Price</th>
              <th class="p-2 text-left">VAT</th>
              <th class="p-2 text-left">Ext. Price</th>
              <th class="p-2 text-left">Actions</th>
            </tr>
          </thead>
          <tbody id="itemsBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Notes / Actions -->
    <section class="grid md:grid-cols-3 gap-4 items-start">
      <div class="md:col-span-2 bg-white rounded-2xl p-4 md:p-5 shadow-sm ring-1 ring-slate-100">
        <h2 class="font-semibold mb-3">Notes (appear on PDF)</h2>
        <textarea id="notes" rows="5" class="w-full border rounded-lg px-3 py-2" placeholder="Any terms, testing notes, warranty, etc."></textarea>
      </div>
      <div class="bg-white rounded-2xl p-4 md:p-5 shadow-sm ring-1 ring-slate-100 flex flex-col gap-3">
        <button id="clearBtn" class="px-4 py-2 rounded-xl bg-slate-100 hover:bg-slate-200">Clear Form</button>
      </div>
    </section>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const nf = (n) => Number(n||0);
    const money = (v, cur) => {
      try { return new Intl.NumberFormat(undefined,{style:'currency',currency:cur}).format(nf(v)); }
      catch { return (cur||'USD') + ' ' + nf(v).toFixed(2); }
    };

    // ----- LOGO (auto-load from repo + optional upload override) -----
    const LOGO_URL = 'Logo_color_white_background (1).png'; // exact filename in your repo
    let logoDataUrl = null;
    let logoImg = null;

    async function loadRepoLogo() {
      try {
        const res = await fetch(LOGO_URL, { cache: 'no-store' });
        if (!res.ok) return;
        const blob = await res.blob();
        const reader = new FileReader();
        reader.onload = (ev) => {
          logoDataUrl = ev.target.result;
          logoImg = new Image();
          logoImg.onload = () => {
            const prev = $('logoPreview');
            prev.src = logoDataUrl;
            prev.classList.remove('hidden');
            $('logoPlaceholder').classList.add('hidden');
          };
          logoImg.src = logoDataUrl;
        };
        reader.readAsDataURL(blob);
      } catch (_) {}
    }

    $('logoFile').addEventListener('change', (e)=>{
      const f = e.target.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = ev => {
        logoDataUrl = ev.target.result;
        logoImg = new Image();
        logoImg.onload = () => {
          const img = $('logoPreview');
          img.src = logoDataUrl; img.classList.remove('hidden');
          $('logoPlaceholder').classList.add('hidden');
        };
        logoImg.src = logoDataUrl;
      };
      r.readAsDataURL(f);
    });

    // Fit logo proportionally within maxW × maxH
    function drawLogoFitted(doc, x, y, maxW, maxH) {
      if (!logoDataUrl || !logoImg) return;
      const iw = logoImg.naturalWidth || logoImg.width;
      const ih = logoImg.naturalHeight || logoImg.height;
      if (!iw || !ih) return;
      const ratio = Math.min(maxW / iw, maxH / ih);
      const w = Math.max(1, iw * ratio);
      const h = Math.max(1, ih * ratio);
      doc.addImage(logoDataUrl, 'PNG', x, y, w, h, undefined, 'FAST');
    }

    // ----- Items table -----
    function addRow(d={}) {
      const tr = document.createElement('tr');
      tr.className='border-b';
      tr.innerHTML = `
        <td class="p-2"><input class="w-full border rounded-lg px-2 py-1" placeholder="Part Number" value="${d.part||''}"></td>
        <td class="p-2"><input class="w-full border rounded-lg px-2 py-1" placeholder="Description" value="${d.desc||''}"></td>
        <td class="p-2"><input type="number" min="0" step="1" class="w-24 border rounded-lg px-2 py-1" placeholder="Qty" value="${d.qty||''}"></td>
        <td class="p-2"><input type="number" min="0" step="0.0001" class="w-28 border rounded-lg px-2 py-1" placeholder="Unit" value="${d.unit||''}"></td>
        <td class="p-2"><input type="number" min="0" step="0.01" class="w-24 border rounded-lg px-2 py-1 vatCell" placeholder="Line VAT %"></td>
        <td class="p-2"><input disabled class="w-28 border rounded-lg px-2 py-1 bg-slate-100 extCell" placeholder="0.00"></td>
        <td class="p-2"><button type="button" class="text-sm px-3 py-1 rounded-lg bg-rose-100 text-rose-700 rm">Remove</button></td>`;
      $('itemsBody').appendChild(tr);
      tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', ()=>recalcRow(tr)));
      tr.querySelector('.rm').addEventListener('click', ()=>tr.remove());
    }

    function recalcRow(tr){
      const tds = tr.querySelectorAll('td input');
      const qty = nf(tds[2].value), unit = nf(tds[3].value);
      const ext = qty*unit;
      tr.querySelector('.extCell').value = (isFinite(ext)?ext:0).toFixed(2);
    }

    function gatherItems(){
      const rows = [...document.querySelectorAll('#itemsBody tr')];
      let items=[], subtotal=0, vatTotal=0;
      const globalNoVat = $('noVat').checked;
      const globalVatPct = nf($('vatPct').value);
      rows.forEach(tr=>{
        const tds = tr.querySelectorAll('td input');
        const part = tds[0].value.trim();
        const desc = tds[1].value.trim();
        const qty = nf(tds[2].value);
        const unit = nf(tds[3].value);
        const lineVatPct = globalNoVat ? 0 : (tds[4].value? nf(tds[4].value) : globalVatPct);
        const ext = qty*unit;
        if(part && qty>0){
          const vat = ext * (lineVatPct/100);
          items.push({part, desc, qty, unit, ext, vat, vatPct: lineVatPct});
          subtotal += ext; vatTotal += vat;
        }
      });
      return {items, subtotal, vatTotal};
    }

    // First row and Add button (this fixes the issue)
    addRow({});
    $('addRowBtn').addEventListener('click', () => addRow({}));

    document.addEventListener('input', (e)=>{
      if (e.target && e.target.closest('#itemsBody tr')) {
        recalcRow(e.target.closest('tr'));
      }
    });

    $('noVat').addEventListener('change', (e)=>{
      document.querySelectorAll('.vatCell').forEach(el=> el.disabled = e.target.checked);
    });

    $('clearBtn').addEventListener('click', ()=>{
      $('itemsBody').innerHTML='';
      addRow({});
    });

    // ----- PDF generation -----
    $('generateBtn').addEventListener('click', ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      const left=40, right=555;
      const line = y => doc.line(left,y,right,y);

      const docType = $('docType').value;
      const currency = ($('currency').value||'USD').toUpperCase();
      const showGbpEq = $('showGbpEq').value === 'yes';
      const fxRate = nf($('fxRate').value);

      const sellerName = $('sellerName').value;
      const sellerAddress = $('sellerAddress').value;
      const sellerVat = $('sellerVat').value;
      const buyerCompany = $('buyerCompany').value;
      const buyerContact = $('buyerContact').value;
      const billTo = $('billTo').value;
      const shipTo = $('shipTo').value;
      const docNumber = $('docNumber').value;
      const docDate = $('docDate').value;
      const poNumber = $('poNumber').value;
      const salesperson = $('salesperson').value;
      const netTerms = $('netTerms').value;
      const incoterms = $('incoterms').value;
      const leadTime = $('leadTime').value;
      const cooHts = $('cooHts').value;
      const shipping = nf($('shipping').value);
      const notes = $('notes').value;

      const {items, subtotal, vatTotal} = gatherItems();
      const total = subtotal + vatTotal + shipping;

      // Header + properly-fitted logo (brand look)
      drawLogoFitted(doc, left, 28, 160, 90);
      doc.setFont('helvetica','bold'); doc.setFontSize(18);
      doc.text(docType==='invoice'?'TAX INVOICE':'Sales Order Confirmation', right, 42, {align:'right'});
      doc.setFont('helvetica','normal'); doc.setFontSize(10);
      if (docNumber) doc.text(`${docType==='invoice'?'Invoice':'SO'} Number: ${docNumber}`, right, 58, {align:'right'});
      if (docDate) doc.text(`Date: ${docDate}`, right, 72, {align:'right'});
      if (poNumber) doc.text(`Reference / PO: ${poNumber}`, right, 86, {align:'right'});
      if (sellerVat) doc.text(`VAT Number: ${sellerVat}`, right, 100, {align:'right'});

      // Parties
      let y=132;
      doc.setFont('helvetica','bold'); doc.text('Seller', left, y);
      doc.text('Buyer', 300, y);
      doc.setFont('helvetica','normal');
      y+=14; doc.text(sellerName||'-', left, y); doc.text(buyerCompany||'-', 300, y);
      y+=12; doc.text(sellerAddress||'-', left, y, {maxWidth:220}); doc.text(buyerContact||'-', 300, y, {maxWidth:220});
      y+=58; line(y); y+=16;

      // Terms & addresses
      doc.setFont('helvetica','bold'); doc.text('Commercial Terms', left, y);
      doc.setFont('helvetica','normal');
      doc.text(`Currency: ${currency}   Net Terms: ${netTerms||'-'}   Incoterms: ${incoterms||'-'}   Salesperson: ${salesperson||'-'}`, left, y+14);
      doc.setFont('helvetica','bold'); doc.text('Bill To', left, y+38);
      doc.setFont('helvetica','normal'); doc.text(billTo||'-', left, y+52, {maxWidth:220});
      doc.setFont('helvetica','bold'); doc.text('Ship To', 300, y+38);
      doc.setFont('helvetica','normal'); doc.text(shipTo||'-', 300, y+52, {maxWidth:240});

      // Items
      const tableY = y+90;
      const body = items.length ? items.map((it,i)=>[
        i+1, it.part, it.desc||'', it.qty, money(it.unit, currency), it.vatPct? it.vatPct.toFixed(2)+'%':'No VAT', money(it.ext, currency)
      ]) : [['','','No items added','','','','']];
      doc.autoTable({
        startY: tableY,
        head: [['#','Part Number','Description','Qty','Unit Price','VAT','Ext. Price']],
        body,
        styles:{fontSize:9, cellPadding:6},
        headStyles:{fillColor:[15,23,42]},
        columnStyles:{
          0:{cellWidth:24, halign:'right'},
          1:{cellWidth:120},
          2:{cellWidth:160},
          3:{cellWidth:40, halign:'right'},
          4:{cellWidth:70, halign:'right'},
          5:{cellWidth:60, halign:'center'},
          6:{cellWidth:80, halign:'right'}
        },
        didDrawPage: function () {
          const pageCount = doc.getNumberOfPages();
          doc.setFontSize(9);
          doc.text(`Page ${doc.internal.getCurrentPageInfo().pageNumber} of ${pageCount}`, right, doc.internal.pageSize.height-18, {align:'right'});
        }
      });
      let after = doc.lastAutoTable ? doc.lastAutoTable.finalY + 12 : tableY + 40;

      // Totals
      const vatLabel = $('noVat').checked ? 'No VAT' : 'VAT';
      doc.setFont('helvetica','bold'); doc.text('Summary', left, after);
      doc.setFont('helvetica','normal');
      after+=14;
      doc.text(`Subtotal: ${money(subtotal, currency)}`, left, after);
      doc.text(`${vatLabel}: ${money(vatTotal, currency)}`, left, after+14);
      doc.text(`Shipping: ${money(nf(shipping), currency)}`, left, after+28);
      doc.setFont('helvetica','bold'); doc.text(`TOTAL: ${money(total, currency)}`, left, after+48);

      if (showGbpEq && currency !== 'GBP' && fxRate>0) {
        const gbpValue = total / fxRate;
        doc.setFont('helvetica','normal');
        doc.text(`*GBP Equivalent Conversion`, left, after+68);
        doc.text(`1 GBP = ${fxRate.toFixed(5)} ${currency}`, left, after+82);
        doc.setFont('helvetica','bold');
        doc.text(`TOTAL GBP: ${money(gbpValue, 'GBP')}`, left, after+98);
      }

      // Notes / extras
      let blockY = after + 120;
      if (leadTime) { doc.setFont('helvetica','bold'); doc.text('Lead Time / Delivery', left, blockY);
        doc.setFont('helvetica','normal'); doc.text(leadTime, left, blockY+14); blockY += 34; }
      if (cooHts) { doc.setFont('helvetica','bold'); doc.text('COO/HTS', left, blockY);
        doc.setFont('helvetica','normal'); doc.text(cooHts, left, blockY+14); blockY += 34; }
      if (notes)  { doc.setFont('helvetica','bold'); doc.text('Notes', left, blockY);
        doc.setFont('helvetica','normal'); doc.text(notes, left, blockY+14, {maxWidth: right-left}); blockY += 54; }

      if (docType==='so') {
        doc.setFont('helvetica','bold'); doc.text('Authorised Signature (Seller):', left, blockY+120);
        doc.line(left, blockY+132, left+220, blockY+132);
        doc.text('Authorised Signature (Buyer):', 300, blockY+120);
        doc.line(300, blockY+132, 520, blockY+132);
      }

      const fn = (docType==='invoice'?'Invoice-':'SO-') + (docNumber||'Document') + '.pdf';
      doc.save(fn);
    });

    // Start
    loadRepoLogo();
  </script>
</body>
</html>


